---
suite: test deployment
templates:
  - deployment.yaml
tests:

  - it: should render with good default values
    asserts:
      - isKind:
          of: Deployment
      - hasDocuments:
          count: 1
      - isNull:
          path: metadata.annotations
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: spec.revisionHistoryLimit
          value: 2
      - equal:
          path: spec.template.spec.containers[0].image
          value: thejenkinsxfiles/mulder:1.0.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Always
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 0.1
              memory: 32M
            limits:
              cpu: 1
              memory: 128M
      - isNull:
          path: spec.template.spec.imagePullSecrets
      - isNull:
          path: spec.template.metadata.annotations

  - it: should render with custom values
    release:
      name: test-release
    set:
      replicaCount: 2
      revisionHistoryLimit: 3
      image:
        repository: registry/repository/image
        tag: "1.0"
        pullPolicy: IfNotPresent
        pullSecret: my-secret
      deployment:
        labels:
          chart: "{{ .Chart.Name }}"
        annotations:
          release: "{{ .Release.Name }}"
        pod:
          labels:
            chart: "{{ .Chart.Name }}"
          annotations:
            release: "{{ .Release.Name }}"
      resources:
        requests:
          cpu: 1
          memory: 64M
        limits:
          cpu: 2
          memory: 128M
    asserts:
      - equal:
          path: metadata.labels.chart
          value: mulder
      - equal:
          path: metadata.annotations
          value:
            release: test-release
      - equal:
          path: spec.replicas
          value: 2
      - equal:
          path: spec.revisionHistoryLimit
          value: 3
      - equal:
          path: spec.template.spec.containers[0].image
          value: registry/repository/image:1.0
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent
      - equal:
          path: spec.template.spec.containers[0].resources
          value:
            requests:
              cpu: 1
              memory: 64M
            limits:
              cpu: 2
              memory: 128M
      - contains:
          path: spec.template.spec.imagePullSecrets
          content:
            name: my-secret
      - equal:
          path: spec.template.metadata.labels.chart
          value: mulder
      - equal:
          path: spec.template.metadata.annotations.release
          value: test-release
